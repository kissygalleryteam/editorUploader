/*! editorUploader - v1.0 - 2013-05-24 5:27:06 PM
* Copyright (c) 2013 minghe; Licensed  */
KISSY.add("gallery/editorUploader/1.0/dialog",function(e,r,t,l,a,o,n,i,d){function u(e,r){this.editor=e,this.config=r,t.Utils.lazyRun(this,"_prepareShow","_realShow")}var s=r.all,p=a.Dialog;return e.augment(u,{addRes:t.Utils.addRes,destroy:t.Utils.destroyRes,show:function(){var e=this;e.editor,e.dialog||(e.dialog=new p({headerContent:"\u6279\u91cf\u4e0a\u4f20",prefixCls:"ks-editor-",mask:!1,plugins:[new l({handlers:[".ks-editor-stdmod-header"]})],focus4e:!1,width:"602px"}).render(),e.addRes(e.dialog),e._append());var r=e.dialog;r.show(),r.center(),e._renderUploader()},_append:function(){var e=this,r=e.dialog;if(!r)return e;var t=r.get("body"),l=e.config.tpl;return l?(t.html(l),e):e},_renderUploader:function(){var e=this,r=e.config;if(e.uploader)return!1;var t=r.queueTarget,l=new o(r.target,r);e.uploader=l,l.theme(new n({queueTarget:t})),l.plug(new i(r.auth||{})).plug(new d({isHide:!1}));var a=s(t).parent().parent(".J_UploaderQueueWrapper"),u=a.all(".J_InsertContent");u.on("click",e._insertHandler,e),l.on("add",function(){"none"==a.css("display")&&a.fadeIn(.5)}),l.on("remove",function(){l.get("queue").get("files").length||a.fadeOut(.5)});var p=l.get("queue");s(".J_ClearQueue").on("click",function(e){e.preventDefault(),p.clear()}),s(".J_StartUpload").on("click",function(){l.uploadFiles("waiting")})},_insertHandler:function(){var r=this,t=r.editor,l=t.get("document")[0],a=r.uploader,o=a.get("queue"),n=o.getFiles("success");if(!n.length)return alert("\u4e0d\u5b58\u5728\u6210\u529f\u4e0a\u4f20\u7684\u56fe\u7247\uff01"),!1;e.each(n,function(e){var r=e.result.url;(new Image).src=r,t.insertElement(s("<p>&nbsp;<img src='"+r+"'/>&nbsp;</p>",l)),o.remove(e.id)});var i=r.dialog;i.hide()}}),u},{requires:["node","editor","component/plugin/drag","overlay","gallery/uploader/1.4/","gallery/uploader/1.4/themes/editorMultipleUploader/","gallery/uploader/1.4/plugins/auth/auth","gallery/uploader/1.4/plugins/proBars/proBars","gallery/uploader/1.4/themes/editorMultipleUploader/style.css"]});